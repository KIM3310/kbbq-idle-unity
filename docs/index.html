<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-adsense-account" content="ca-pub-0000000000000000" />
    <title>KBBQ Idle | Playable WebGL</title>
    <meta name="description" content="Play KBBQ Idle on Cloudflare Pages with optional backend integrations and policy-ready site sections." />
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0000000000000000" crossorigin="anonymous"></script>
    <style>
      :root { --bg:#f7efe2; --card:#fffdf8; --line:#e4d7bf; --ink:#32281f; --muted:#6d594a; --accent:#b24d29; }
      * { box-sizing:border-box; }
      body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--ink); }
      header { padding:16px 20px; background:#fff; border-bottom:1px solid var(--line); display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
      header a { color:var(--accent); text-decoration:none; font-size:14px; }
      .wrap { max-width:1080px; margin:0 auto; padding:24px 16px 36px; display:grid; gap:16px; }
      .card { border:1px solid var(--line); background:var(--card); border-radius:14px; padding:14px; }
      h1,h2 { margin:0 0 10px; }
      p,li { color:var(--muted); line-height:1.56; }
      .playbox { display:grid; gap:12px; }
      .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
      input,button { border-radius:8px; border:1px solid var(--line); padding:8px 10px; font-size:14px; }
      button { background:#fff; cursor:pointer; }
      #unityContainer { width:100%; min-height:520px; border:1px solid var(--line); border-radius:10px; background:#101010; display:flex; align-items:center; justify-content:center; overflow:hidden; }
      #unityCanvas { width:100%; height:100%; display:none; }
      #status { font-size:14px; color:var(--muted); }
      #preflight { font-size:13px; color:var(--muted); line-height:1.5; }
      .ad { min-height:96px; border:1px dashed var(--line); border-radius:10px; padding:8px; background:#fff; }
      footer { max-width:1080px; margin:0 auto; padding:0 16px 30px; color:var(--muted); font-size:14px; }
    </style>
  </head>
  <body>
    <header>
      <a href="./index.html">Play</a>
      <a href="./privacy.html">Privacy</a>
      <a href="./terms.html">Terms</a>
      <a href="./contact.html">Contact</a>
      <a href="./compliance.html">Compliance</a>
      <a href="https://github.com/KIM3310/kbbq-idle-unity">GitHub</a>
    </header>

    <main class="wrap">
      <section class="card playbox">
        <h1>KBBQ Idle WebGL</h1>
        <p>
          Unity WebGL build files must exist under <code>docs/Build/</code>. Set the build name below
          (for example <code>KBBQIdleWebGL</code>) and start.
        </p>
        <div class="toolbar">
          <input id="buildName" placeholder="Unity build base name" value="KBBQIdleWebGL" />
          <button id="checkBtn">Check Build Files</button>
          <button id="startBtn">Start Game</button>
        </div>
        <div id="status">Ready. Click Start Game after uploading WebGL build artifacts.</div>
        <div id="preflight">Tip: if your build uses `.unityweb`/`.br`/`.gz`, this page auto-detects those formats.</div>
        <div id="unityContainer">
          <canvas id="unityCanvas" width="960" height="600"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Trust & Policy</h2>
        <ul>
          <li>Contact: kbbq-idle@ops.local</li>
          <li>Privacy: gameplay/account telemetry is limited to service operation scope.</li>
          <li>Terms: in-game economy values may change during balancing updates.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Sponsored Slot</h2>
        <div class="ad">
          <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-0000000000000000" data-ad-slot="1234567890" data-ad-format="auto" data-full-width-responsive="true"></ins>
        </div>
      </section>
    </main>

    <footer>Cloudflare Pages output directory: <code>docs</code> Â· Last updated: 2026-02-18</footer>

    <script>
      const canvas = document.getElementById('unityCanvas');
      const container = document.getElementById('unityContainer');
      const statusNode = document.getElementById('status');
      const preflightNode = document.getElementById('preflight');
      const buildInput = document.getElementById('buildName');
      const checkBtn = document.getElementById('checkBtn');
      const startBtn = document.getElementById('startBtn');
      let unityInstance = null;

      function setStatus(text) {
        statusNode.textContent = text;
      }

      function setPreflight(text) {
        preflightNode.textContent = text;
      }

      function isHtmlContentType(contentType) {
        return typeof contentType === 'string' && contentType.toLowerCase().includes('text/html');
      }

      async function fetchProbe(url) {
        const options = {
          method: 'GET',
          cache: 'no-store',
          headers: { Range: 'bytes=0-255' },
        };

        const response = await fetch(url, options);
        const contentType = response.headers.get('content-type') || '';
        if (!response.ok || isHtmlContentType(contentType)) {
          return { ok: false, contentType, text: '' };
        }

        const text = await response.text();
        const lowered = text.trimStart().toLowerCase();
        if (lowered.startsWith('<!doctype html') || lowered.startsWith('<html')) {
          return { ok: false, contentType, text };
        }

        return { ok: true, contentType, text };
      }

      async function urlExists(url) {
        try {
          const head = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          const contentType = head.headers.get('content-type') || '';
          if (head.ok && !isHtmlContentType(contentType)) {
            return true;
          }
        } catch (_err) {
          // fallback below
        }

        try {
          const probe = await fetchProbe(url);
          return probe.ok;
        } catch (_err) {
          return false;
        }
      }

      async function pickCandidate(candidates, validator) {
        for (const candidate of candidates) {
          try {
            const probe = await fetchProbe(candidate);
            if (!probe.ok) {
              continue;
            }
            if (!validator || validator(probe.text, probe.contentType)) {
              return candidate;
            }
          } catch (_err) {
            // try next
          }
        }
        return '';
      }

      function normalizeBuildPath(path, base) {
        const raw = String(path || '').trim();
        if (!raw) return '';
        if (raw.startsWith('http://') || raw.startsWith('https://') || raw.startsWith('Build/')) return raw;
        if (raw.startsWith('/')) return raw.slice(1);
        return `Build/${base}.${raw}`;
      }

      async function resolveConfig(base) {
        const jsonUrl = `Build/${base}.json`;
        try {
          const resp = await fetch(jsonUrl, { cache: 'no-store' });
          if (resp.ok) {
            const parsed = await resp.json();
            if (parsed && parsed.dataUrl && parsed.frameworkUrl && parsed.codeUrl) {
              return {
                dataUrl: normalizeBuildPath(parsed.dataUrl, base),
                frameworkUrl: normalizeBuildPath(parsed.frameworkUrl, base),
                codeUrl: normalizeBuildPath(parsed.codeUrl, base),
                symbolsUrl: parsed.symbolsUrl ? normalizeBuildPath(parsed.symbolsUrl, base) : undefined,
                companyName: parsed.companyName || 'KBBQ',
                productName: parsed.productName || 'KBBQ Idle',
                productVersion: parsed.productVersion || '1.0',
                streamingAssetsUrl: parsed.streamingAssetsUrl || 'StreamingAssets',
              };
            }
          }
        } catch (_err) {
          // fall through to candidate scan
        }

        const candidates = {
          dataUrl: [
            `Build/${base}.data`,
            `Build/${base}.data.unityweb`,
            `Build/${base}.data.br`,
            `Build/${base}.data.gz`,
          ],
          frameworkUrl: [
            `Build/${base}.framework.js`,
            `Build/${base}.framework.js.unityweb`,
            `Build/${base}.framework.js.br`,
            `Build/${base}.framework.js.gz`,
          ],
          codeUrl: [
            `Build/${base}.wasm`,
            `Build/${base}.wasm.unityweb`,
            `Build/${base}.wasm.br`,
            `Build/${base}.wasm.gz`,
          ],
          symbolsUrl: [
            `Build/${base}.symbols.json`,
            `Build/${base}.symbols.json.unityweb`,
            `Build/${base}.symbols.json.br`,
            `Build/${base}.symbols.json.gz`,
          ],
        };

        const resolved = {};
        resolved.dataUrl = await pickCandidate(candidates.dataUrl);
        resolved.frameworkUrl = await pickCandidate(candidates.frameworkUrl, (text) => text.includes('createUnityInstance') || text.includes('unityFramework'));
        resolved.codeUrl = await pickCandidate(candidates.codeUrl);
        resolved.symbolsUrl = await pickCandidate(candidates.symbolsUrl);

        if (!resolved.dataUrl || !resolved.frameworkUrl || !resolved.codeUrl) {
          throw new Error('Missing core build files (.data/.framework.js/.wasm).');
        }

        return {
          dataUrl: resolved.dataUrl,
          frameworkUrl: resolved.frameworkUrl,
          codeUrl: resolved.codeUrl,
          symbolsUrl: resolved.symbolsUrl,
          streamingAssetsUrl: 'StreamingAssets',
          companyName: 'KBBQ',
          productName: 'KBBQ Idle',
          productVersion: '1.0',
        };
      }

      async function preflightCheck(buildBase) {
        const base = String(buildBase || '').trim();
        if (!base) {
          setPreflight('Build name is required.');
          return null;
        }
        setPreflight('Scanning Build/ assets...');
        try {
          const config = await resolveConfig(base);
          const symbols = config.symbolsUrl ? `, symbols: ${config.symbolsUrl}` : '';
          setPreflight(`OK - data: ${config.dataUrl}, framework: ${config.frameworkUrl}, wasm: ${config.codeUrl}${symbols}`);
          return config;
        } catch (err) {
          setPreflight(`Build check failed: ${err?.message || String(err)}`);
          return null;
        }
      }

      async function disposeUnityInstance() {
        if (!unityInstance || typeof unityInstance.Quit !== 'function') return;
        try {
          await unityInstance.Quit();
        } catch (_err) {
          // no-op
        }
        unityInstance = null;
      }

      async function loadUnity(buildBase) {
        const base = String(buildBase || '').trim();
        if (!base) {
          setStatus('Build name is required.');
          return;
        }

        if (typeof WebAssembly !== 'object') {
          setStatus('This browser does not support WebAssembly.');
          return;
        }

        const config = await preflightCheck(base);
        if (!config) {
          setStatus('Cannot start. Build check failed.');
          return;
        }

        await disposeUnityInstance();
        setStatus('Loading Unity loader...');
        const loaderUrl = `Build/${base}.loader.js`;
        const existing = document.getElementById('unity-loader-script');
        if (existing) existing.remove();

        const script = document.createElement('script');
        script.id = 'unity-loader-script';
        script.src = loaderUrl;
        script.onload = () => {
          const createFn = window.createUnityInstance || (typeof createUnityInstance === 'function' ? createUnityInstance : null);
          if (typeof createFn !== 'function') {
            setStatus('Unity loader loaded but createUnityInstance is missing. Check build output.');
            return;
          }
          setStatus('Initializing game...');
          canvas.style.display = 'block';
          createFn(canvas, config, (progress) => {
            setStatus(`Loading ${(progress * 100).toFixed(0)}%`);
          })
            .then((instance) => {
              unityInstance = instance;
              setStatus('Game loaded.');
            })
            .catch((err) => setStatus(`Failed to launch: ${err}`));
        };
        script.onerror = () => {
          setStatus('Loader file not found. Build Unity WebGL and copy files into docs/Build/.');
        };
        document.body.appendChild(script);
      }

      checkBtn.addEventListener('click', () => {
        void preflightCheck(buildInput.value);
      });
      startBtn.addEventListener('click', () => loadUnity(buildInput.value));
      try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) {}
    </script>
  </body>
</html>
